import { useState, useEffect, useCallback, useRef, useMemo } from "react";

// â”€â”€â”€ SEED DATA â”€â”€â”€
const PATIENTS = [
  {
    id: "P001", name: "Martinez, Elena", mrn: "MRN-482910", dob: "1958-03-14", age: 67, sex: "F",
    location: "ED-Bay 12", encounter: "ENC-90421", status: "Active",
    chief: "Chest pain, diaphoresis x 2hrs",
    allergies: [{ agent: "Penicillin", reaction: "Anaphylaxis", severity: "High" }, { agent: "Sulfa", reaction: "Rash", severity: "Moderate" }],
    alerts: ["Fall Risk", "DVT Prophylaxis Required"],
    problems: ["Hypertension", "Type 2 Diabetes Mellitus", "Hyperlipidemia", "GERD", "Osteoarthritis bilateral knees"],
    homeMeds: [
      { name: "Lisinopril 20mg", route: "PO", freq: "Daily" },
      { name: "Metformin 1000mg", route: "PO", freq: "BID" },
      { name: "Atorvastatin 40mg", route: "PO", freq: "QHS" },
      { name: "Omeprazole 20mg", route: "PO", freq: "Daily" },
      { name: "Aspirin 81mg", route: "PO", freq: "Daily" },
    ],
    vitals: [
      { time: "14:32", hr: 102, bp: "168/94", rr: 22, spo2: 94, temp: 98.8, pain: 8 },
      { time: "14:50", hr: 98, bp: "162/90", rr: 20, spo2: 95, temp: 98.7, pain: 7 },
      { time: "15:15", hr: 94, bp: "155/88", rr: 18, spo2: 96, temp: 98.6, pain: 5 },
    ],
    results: [
      { id: "R1", name: "Troponin I", value: "0.42", unit: "ng/mL", ref: "<0.04", flag: "CRITICAL", time: "14:45", ack: false, cat: "Lab" },
      { id: "R2", name: "Troponin I (repeat)", value: "0.89", unit: "ng/mL", ref: "<0.04", flag: "CRITICAL", time: "16:45", ack: false, cat: "Lab" },
      { id: "R3", name: "WBC", value: "11.2", unit: "K/uL", ref: "4.5-11.0", flag: "HIGH", time: "14:50", ack: false, cat: "Lab" },
      { id: "R4", name: "Hemoglobin", value: "13.1", unit: "g/dL", ref: "12.0-16.0", flag: "NORMAL", time: "14:50", ack: false, cat: "Lab" },
      { id: "R5", name: "Platelets", value: "245", unit: "K/uL", ref: "150-400", flag: "NORMAL", time: "14:50", ack: false, cat: "Lab" },
      { id: "R6", name: "Sodium", value: "138", unit: "mEq/L", ref: "136-145", flag: "NORMAL", time: "14:52", ack: false, cat: "Lab" },
      { id: "R7", name: "Potassium", value: "4.1", unit: "mEq/L", ref: "3.5-5.0", flag: "NORMAL", time: "14:52", ack: false, cat: "Lab" },
      { id: "R8", name: "Creatinine", value: "1.4", unit: "mg/dL", ref: "0.6-1.2", flag: "HIGH", time: "14:52", ack: false, cat: "Lab" },
      { id: "R9", name: "Glucose", value: "224", unit: "mg/dL", ref: "70-100", flag: "HIGH", time: "14:52", ack: false, cat: "Lab" },
      { id: "R10", name: "BNP", value: "380", unit: "pg/mL", ref: "<100", flag: "HIGH", time: "15:00", ack: false, cat: "Lab" },
      { id: "R11", name: "PT/INR", value: "1.1", unit: "", ref: "0.9-1.1", flag: "NORMAL", time: "14:55", ack: false, cat: "Lab" },
      { id: "R12", name: "CXR PA/Lat", value: "Mild cardiomegaly. No acute infiltrate. No pneumothorax.", flag: "ABNORMAL", time: "15:10", ack: false, cat: "Imaging", report: "FINDINGS: Heart is mildly enlarged. Lungs are clear. No pleural effusion. No pneumothorax. Mediastinal contours are normal.\n\nIMPRESSION: Mild cardiomegaly without acute cardiopulmonary process." },
      { id: "R13", name: "EKG 12-Lead", value: "ST depression V3-V6, T-wave inversions in lateral leads. Sinus tachycardia.", flag: "ABNORMAL", time: "14:40", ack: false, cat: "Diagnostic" },
    ],
    imaging: [
      { id: "I1", name: "CXR PA/Lat", status: "Completed", time: "15:10", report: "FINDINGS: Heart is mildly enlarged. Lungs are clear bilaterally. No pleural effusion. No pneumothorax.\n\nIMPRESSION: Mild cardiomegaly. No acute cardiopulmonary process." },
      { id: "I2", name: "CT Coronary Angiography", status: "Ordered", time: "15:30", report: null },
    ],
    inptMeds: [
      { id: "M1", name: "Aspirin 325mg", route: "PO", freq: "STAT then Daily", sched: "STAT", status: "Due", lastGiven: null },
      { id: "M2", name: "Heparin 60 units/kg IV bolus", route: "IV", freq: "STAT", sched: "STAT", status: "Due", lastGiven: null },
      { id: "M3", name: "Heparin drip 12 units/kg/hr", route: "IV", freq: "Continuous", sched: "Continuous", status: "Due", lastGiven: null },
      { id: "M4", name: "Nitroglycerin 0.4mg SL", route: "SL", freq: "PRN chest pain", sched: "PRN", status: "Available", lastGiven: null },
      { id: "M5", name: "Morphine 2mg IV", route: "IV", freq: "PRN pain q4h", sched: "PRN", status: "Available", lastGiven: null },
      { id: "M6", name: "Metoprolol 5mg IV", route: "IV", freq: "q5min x3 PRN", sched: "PRN", status: "Available", lastGiven: null },
    ],
    edCourse: "",
    notes: [],
  },
  {
    id: "P002", name: "Johnson, Marcus", mrn: "MRN-738201", dob: "1985-11-22", age: 40, sex: "M",
    location: "ED-Bay 5", encounter: "ENC-90422", status: "Active",
    chief: "Fall from ladder, right arm deformity, laceration",
    allergies: [{ agent: "Codeine", reaction: "Nausea/Vomiting", severity: "Moderate" }],
    alerts: ["Tetanus Due"],
    problems: ["Asthma (mild intermittent)", "Seasonal allergies"],
    homeMeds: [{ name: "Albuterol inhaler", route: "INH", freq: "PRN" }, { name: "Cetirizine 10mg", route: "PO", freq: "Daily" }],
    vitals: [
      { time: "13:10", hr: 110, bp: "148/92", rr: 20, spo2: 98, temp: 98.4, pain: 9 },
      { time: "13:35", hr: 98, bp: "138/86", rr: 18, spo2: 99, temp: 98.5, pain: 7 },
      { time: "14:00", hr: 88, bp: "132/82", rr: 16, spo2: 99, temp: 98.4, pain: 5 },
    ],
    results: [
      { id: "R1", name: "WBC", value: "9.8", unit: "K/uL", ref: "4.5-11.0", flag: "NORMAL", time: "13:25", ack: false, cat: "Lab" },
      { id: "R2", name: "Hemoglobin", value: "14.8", unit: "g/dL", ref: "13.5-17.5", flag: "NORMAL", time: "13:25", ack: false, cat: "Lab" },
      { id: "R3", name: "Platelets", value: "310", unit: "K/uL", ref: "150-400", flag: "NORMAL", time: "13:25", ack: false, cat: "Lab" },
      { id: "R4", name: "XR Right Forearm", value: "Displaced distal radius fracture (Colles type). No ulnar fracture.", flag: "ABNORMAL", time: "13:45", ack: false, cat: "Imaging", report: "FINDINGS: Displaced fracture of the distal radius with dorsal angulation consistent with Colles fracture. Ulna intact. No dislocation.\n\nIMPRESSION: Displaced distal radius fracture. Orthopedic consultation recommended." },
    ],
    imaging: [
      { id: "I1", name: "XR Right Forearm 2-view", status: "Completed", time: "13:45", report: "FINDINGS: Displaced fracture of the distal radius with dorsal angulation (Colles type). Ulna intact. No dislocation.\n\nIMPRESSION: Displaced distal radius fracture. Ortho consult recommended." },
    ],
    inptMeds: [
      { id: "M1", name: "Fentanyl 50mcg IV", route: "IV", freq: "q1h PRN pain", sched: "PRN", status: "Available", lastGiven: null },
      { id: "M2", name: "Ondansetron 4mg IV", route: "IV", freq: "q6h PRN nausea", sched: "PRN", status: "Available", lastGiven: null },
      { id: "M3", name: "Cefazolin 2g IV", route: "IV", freq: "STAT (pre-op)", sched: "STAT", status: "Due", lastGiven: null },
      { id: "M4", name: "Tetanus/Diphtheria vaccine", route: "IM", freq: "STAT x1", sched: "STAT", status: "Due", lastGiven: null },
    ],
    edCourse: "",
    notes: [],
  },
  {
    id: "P003", name: "Chen, Lisa", mrn: "MRN-219384", dob: "1972-07-08", age: 53, sex: "F",
    location: "ED-Bay 8", encounter: "ENC-90423", status: "Active",
    chief: "Acute onset dyspnea, productive cough x 3 days, fever",
    allergies: [],
    alerts: ["Isolation: Droplet Precautions"],
    problems: ["COPD (moderate)", "Current smoker (1 ppd x 30 yrs)", "Osteoporosis", "Depression"],
    homeMeds: [
      { name: "Tiotropium 18mcg", route: "INH", freq: "Daily" },
      { name: "Fluticasone/Salmeterol 250/50", route: "INH", freq: "BID" },
      { name: "Albuterol nebulizer", route: "INH", freq: "PRN" },
      { name: "Sertraline 100mg", route: "PO", freq: "Daily" },
      { name: "Alendronate 70mg", route: "PO", freq: "Weekly" },
    ],
    vitals: [
      { time: "12:45", hr: 108, bp: "130/78", rr: 28, spo2: 88, temp: 101.8, pain: 4 },
      { time: "13:15", hr: 102, bp: "128/76", rr: 24, spo2: 91, temp: 101.4, pain: 3 },
      { time: "14:00", hr: 96, bp: "126/74", rr: 22, spo2: 93, temp: 100.8, pain: 2 },
    ],
    results: [
      { id: "R1", name: "WBC", value: "16.8", unit: "K/uL", ref: "4.5-11.0", flag: "HIGH", time: "13:00", ack: false, cat: "Lab" },
      { id: "R2", name: "Hemoglobin", value: "11.8", unit: "g/dL", ref: "12.0-16.0", flag: "LOW", time: "13:00", ack: false, cat: "Lab" },
      { id: "R3", name: "Procalcitonin", value: "2.4", unit: "ng/mL", ref: "<0.1", flag: "CRITICAL", time: "13:10", ack: false, cat: "Lab" },
      { id: "R4", name: "Lactate", value: "2.8", unit: "mmol/L", ref: "0.5-2.0", flag: "HIGH", time: "13:00", ack: false, cat: "Lab" },
      { id: "R5", name: "BMP â€” all WNL except Glucose 142", value: "See panel", unit: "", ref: "", flag: "HIGH", time: "13:05", ack: false, cat: "Lab" },
      { id: "R6", name: "Blood Cx x2", value: "Pending", unit: "", ref: "", flag: "PENDING", time: "13:00", ack: false, cat: "Lab" },
      { id: "R7", name: "CXR PA/Lat", value: "Right lower lobe consolidation. Small right pleural effusion.", flag: "ABNORMAL", time: "13:20", ack: false, cat: "Imaging", report: "FINDINGS: Right lower lobe consolidation with air bronchograms. Small right pleural effusion. Left lung clear. Heart size normal.\n\nIMPRESSION: Right lower lobe pneumonia with small parapneumonic effusion." },
      { id: "R8", name: "Influenza/COVID PCR", value: "Pending", unit: "", ref: "", flag: "PENDING", time: "13:00", ack: false, cat: "Lab" },
    ],
    imaging: [
      { id: "I1", name: "CXR PA/Lat", status: "Completed", time: "13:20", report: "Right lower lobe consolidation with air bronchograms. Small right pleural effusion. Left lung clear.\n\nIMPRESSION: RLL pneumonia with small parapneumonic effusion." },
    ],
    inptMeds: [
      { id: "M1", name: "Ceftriaxone 2g IV", route: "IV", freq: "Daily", sched: "Scheduled", status: "Due", lastGiven: null },
      { id: "M2", name: "Azithromycin 500mg IV", route: "IV", freq: "Daily", sched: "Scheduled", status: "Due", lastGiven: null },
      { id: "M3", name: "NS 1000mL bolus", route: "IV", freq: "STAT", sched: "STAT", status: "Due", lastGiven: null },
      { id: "M4", name: "Albuterol 2.5mg neb", route: "INH", freq: "q4h + PRN", sched: "q4h", status: "Due", lastGiven: null },
      { id: "M5", name: "Methylprednisolone 125mg IV", route: "IV", freq: "STAT then q6h", sched: "STAT", status: "Due", lastGiven: null },
      { id: "M6", name: "Acetaminophen 1000mg", route: "PO", freq: "q6h PRN fever/pain", sched: "PRN", status: "Available", lastGiven: null },
    ],
    edCourse: "",
    notes: [],
  },
  {
    id: "P004", name: "Williams, Robert", mrn: "MRN-605827", dob: "1945-01-30", age: 81, sex: "M",
    location: "ICU-Bed 3", encounter: "ENC-90420", status: "Active",
    chief: "Transfer from ED â€” septic shock, UTI source",
    allergies: [{ agent: "Vancomycin", reaction: "Red Man Syndrome", severity: "Moderate" }, { agent: "Iodine contrast", reaction: "Hives", severity: "Moderate" }],
    alerts: ["Fall Risk", "Code Status: Full Code", "Pressors Active"],
    problems: ["Benign prostatic hyperplasia", "Atrial fibrillation (chronic)", "CHF (HFrEF, EF 35%)", "CKD Stage 3b", "Dementia (mild)"],
    homeMeds: [
      { name: "Apixaban 5mg", route: "PO", freq: "BID" },
      { name: "Carvedilol 12.5mg", route: "PO", freq: "BID" },
      { name: "Furosemide 40mg", route: "PO", freq: "Daily" },
      { name: "Tamsulosin 0.4mg", route: "PO", freq: "QHS" },
      { name: "Donepezil 10mg", route: "PO", freq: "QHS" },
    ],
    vitals: [
      { time: "10:00", hr: 118, bp: "78/50", rr: 26, spo2: 92, temp: 103.1, pain: 6 },
      { time: "11:00", hr: 110, bp: "85/55", rr: 24, spo2: 94, temp: 102.4, pain: 5 },
      { time: "12:00", hr: 102, bp: "92/60", rr: 22, spo2: 95, temp: 101.6, pain: 4 },
    ],
    results: [
      { id: "R1", name: "WBC", value: "22.4", unit: "K/uL", ref: "4.5-11.0", flag: "CRITICAL", time: "10:15", ack: false, cat: "Lab" },
      { id: "R2", name: "Lactate", value: "4.6", unit: "mmol/L", ref: "0.5-2.0", flag: "CRITICAL", time: "10:15", ack: false, cat: "Lab" },
      { id: "R3", name: "Creatinine", value: "2.8", unit: "mg/dL", ref: "0.6-1.2", flag: "HIGH", time: "10:20", ack: false, cat: "Lab" },
      { id: "R4", name: "Blood Cx x2", value: "Pending", unit: "", ref: "", flag: "PENDING", time: "10:10", ack: false, cat: "Lab" },
      { id: "R5", name: "Urinalysis", value: "Positive nitrites, >100 WBC, bacteria 3+", flag: "ABNORMAL", time: "10:30", ack: false, cat: "Lab" },
      { id: "R6", name: "Procalcitonin", value: "12.8", unit: "ng/mL", ref: "<0.1", flag: "CRITICAL", time: "10:25", ack: false, cat: "Lab" },
    ],
    imaging: [],
    inptMeds: [
      { id: "M1", name: "Norepinephrine 0.1mcg/kg/min", route: "IV", freq: "Continuous", sched: "Continuous", status: "Running", lastGiven: "10:15" },
      { id: "M2", name: "Meropenem 1g IV", route: "IV", freq: "q8h", sched: "q8h", status: "Due", lastGiven: null },
      { id: "M3", name: "NS 30mL/kg bolus (given in ED)", route: "IV", freq: "STAT", sched: "STAT", status: "Given", lastGiven: "09:45" },
      { id: "M4", name: "Hydrocortisone 100mg IV", route: "IV", freq: "q8h", sched: "q8h", status: "Due", lastGiven: null },
      { id: "M5", name: "Acetaminophen 1000mg", route: "IV", freq: "q6h PRN fever", sched: "PRN", status: "Available", lastGiven: null },
    ],
    edCourse: "81M with hx AFib, HFrEF, CKD3b, BPH presenting with AMS, fever, hypotension. Found to have UTI-source septic shock. 30mL/kg IVF given, started on norepinephrine. Broad-spectrum abx initiated. Transferred to ICU for further management.",
    notes: [],
  },
];

const ORDER_CATALOG = [
  { id: "OC1", name: "CBC with Differential", cat: "Lab", sub: "Hematology" },
  { id: "OC2", name: "Comprehensive Metabolic Panel", cat: "Lab", sub: "Chemistry" },
  { id: "OC3", name: "Basic Metabolic Panel", cat: "Lab", sub: "Chemistry" },
  { id: "OC4", name: "Troponin I", cat: "Lab", sub: "Cardiac" },
  { id: "OC5", name: "BNP", cat: "Lab", sub: "Cardiac" },
  { id: "OC6", name: "PT/INR", cat: "Lab", sub: "Coagulation" },
  { id: "OC7", name: "Urinalysis", cat: "Lab", sub: "Urine" },
  { id: "OC8", name: "Blood Culture x2", cat: "Lab", sub: "Micro" },
  { id: "OC9", name: "Lactate", cat: "Lab", sub: "Chemistry" },
  { id: "OC10", name: "Procalcitonin", cat: "Lab", sub: "Chemistry" },
  { id: "OC11", name: "Lipase", cat: "Lab", sub: "Chemistry" },
  { id: "OC12", name: "D-Dimer", cat: "Lab", sub: "Coagulation" },
  { id: "OC13", name: "Type and Screen", cat: "Lab", sub: "Blood Bank" },
  { id: "OC14", name: "Urine Drug Screen", cat: "Lab", sub: "Toxicology" },
  { id: "OC15", name: "CXR PA/Lateral", cat: "Imaging", sub: "X-Ray" },
  { id: "OC16", name: "CT Head w/o Contrast", cat: "Imaging", sub: "CT" },
  { id: "OC17", name: "CT Abdomen/Pelvis w/ Contrast", cat: "Imaging", sub: "CT" },
  { id: "OC18", name: "CT Angiography Chest (PE Protocol)", cat: "Imaging", sub: "CT" },
  { id: "OC19", name: "XR Extremity 2-view", cat: "Imaging", sub: "X-Ray" },
  { id: "OC20", name: "Ultrasound RUQ", cat: "Imaging", sub: "US" },
  { id: "OC21", name: "EKG 12-Lead", cat: "Diagnostic", sub: "Cardiac" },
  { id: "OC22", name: "Normal Saline 1000mL bolus", cat: "Medication", sub: "IV Fluids" },
  { id: "OC23", name: "Lactated Ringer's 1000mL bolus", cat: "Medication", sub: "IV Fluids" },
  { id: "OC24", name: "Morphine 4mg IV q4h PRN pain", cat: "Medication", sub: "Analgesic" },
  { id: "OC25", name: "Ketorolac 30mg IV x1", cat: "Medication", sub: "Analgesic" },
  { id: "OC26", name: "Ondansetron 4mg IV q6h PRN", cat: "Medication", sub: "Antiemetic" },
  { id: "OC27", name: "Ceftriaxone 2g IV", cat: "Medication", sub: "Antibiotic" },
  { id: "OC28", name: "Azithromycin 500mg IV", cat: "Medication", sub: "Antibiotic" },
  { id: "OC29", name: "Piperacillin-Tazobactam 4.5g IV q6h", cat: "Medication", sub: "Antibiotic" },
  { id: "OC30", name: "Continuous Pulse Oximetry", cat: "Nursing", sub: "Monitoring" },
  { id: "OC31", name: "Telemetry Monitoring", cat: "Nursing", sub: "Monitoring" },
  { id: "OC32", name: "Strict I&O", cat: "Nursing", sub: "Assessment" },
  { id: "OC33", name: "Fall Precautions", cat: "Nursing", sub: "Safety" },
  { id: "OC34", name: "NPO", cat: "Nursing", sub: "Diet" },
  { id: "OC35", name: "Foley Catheter Insertion", cat: "Nursing", sub: "Procedure" },
];

const NOTE_TEMPLATES = {
  "ED Provider Note": `CHIEF COMPLAINT: [complaint]

HISTORY OF PRESENT ILLNESS:
[age][sex] with PMH of [problems] presenting with [complaint]. [HPI details]

REVIEW OF SYSTEMS:
Constitutional: [+/- fever, chills, weight loss]
[System-based review]

PHYSICAL EXAMINATION:
General: [appearance]
HEENT: [findings]
Cardiovascular: [findings]
Pulmonary: [findings]
Abdomen: [findings]
Extremities: [findings]
Neurological: [findings]

MEDICAL DECISION MAKING:
[Assessment and reasoning]

DIAGNOSIS:
1. [Primary]
2. [Secondary]

PLAN:
[Orders, consults, disposition]

Attending: _______________`,
  "Nursing Assessment": `NURSING ASSESSMENT â€” [time]

Patient: [name] | MRN: [mrn]
Chief Complaint: [complaint]

PRIMARY SURVEY:
Airway: [patent/compromised]
Breathing: [rate, effort, SpO2]
Circulation: [HR, BP, skin color]
Disability: [GCS, pupils]
Exposure: [temp, skin exam]

SECONDARY ASSESSMENT:
Pain: [location, scale, characteristics]
Neuro: [orientation, behavior]
Skin: [integrity, wounds, IV sites]
Safety: [fall risk, restraints, isolation]

INTERVENTIONS:
[IVs, medications, procedures performed]

PLAN:
[Pending orders, reassessment timing]

RN: _______________`,
  "Progress Note": `PROGRESS NOTE â€” [date/time]

Subjective: Patient reports [symptoms/changes]

Objective:
Vitals: [latest set]
Assessment: [focused exam findings]
Labs/Results: [pertinent new results]

Assessment/Plan:
[Problem-based A/P]

Provider: _______________`,
  "Procedure Note": `PROCEDURE NOTE

Procedure: [name]
Date/Time: [datetime]
Provider: [name]
Indication: [reason]
Consent: [verbal/written/emergency]
Timeout: Performed â˜

Technique:
[Step-by-step description]

Findings: [results]
Complications: [none/describe]
EBL: [volume]
Specimens: [sent/none]

Post-Procedure Orders: [list]`,
};

const SMART_PHRASES = {
  ".nml": "Within normal limits.",
  ".nad": "No acute distress.",
  ".rrr": "Regular rate and rhythm, no murmurs/rubs/gallops.",
  ".ctab": "Clear to auscultation bilaterally, no wheezes/rales/rhonchi.",
  ".soft": "Soft, non-tender, non-distended, normoactive bowel sounds.",
  ".aox3": "Alert and oriented x3 (person, place, time).",
  ".perrla": "Pupils equal, round, reactive to light and accommodation.",
  ".neuro": "CN II-XII grossly intact. Sensation intact. 5/5 strength in all extremities.",
  ".skin": "Warm, dry, intact. No rashes, lesions, or breakdown noted.",
  ".educ": "Patient educated on diagnosis, treatment plan, and return precautions. Patient verbalized understanding.",
};

const now = () => new Date().toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit", second: "2-digit" });

// â”€â”€â”€ STYLES â”€â”€â”€
const S = {
  bg: "#0f172a", bgCard: "#1e293b", bgInput: "#0f172a", bgHover: "#334155",
  border: "#334155", borderLight: "#475569",
  textPri: "#f1f5f9", textSec: "#94a3b8", textMute: "#64748b",
  blue: "#3b82f6", blueHover: "#2563eb", blueBg: "#1e3a5f",
  green: "#22c55e", greenBg: "#14532d",
  red: "#ef4444", redBg: "#7f1d1d",
  yellow: "#eab308", yellowBg: "#713f12",
  orange: "#f97316", purple: "#a855f7",
  cyan: "#06b6d4",
};

// â”€â”€â”€ MAIN APP â”€â”€â”€
export default function SimEHR() {
  const [patients, setPatients] = useState(JSON.parse(JSON.stringify(PATIENTS)));
  const [selPtId, setSelPtId] = useState("P001");
  const [tab, setTab] = useState("Summary");
  const [role, setRole] = useState("Provider");
  const [unit, setUnit] = useState("ED");
  const [audit, setAudit] = useState([]);
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [rightOpen, setRightOpen] = useState(true);
  const [ptSearch, setPtSearch] = useState("");

  const pt = patients.find(p => p.id === selPtId);

  const log = useCallback((action) => {
    setAudit(a => [{ time: now(), action, pt: selPtId }, ...a].slice(0, 100));
  }, [selPtId]);

  const updatePt = useCallback((id, fn) => {
    setPatients(ps => ps.map(p => p.id === id ? fn({ ...p }) : p));
  }, []);

  const unackCount = pt ? pt.results.filter(r => !r.ack).length : 0;
  const unsignedCount = patients.reduce((c, p) => c + (p.notes || []).filter(n => n.status === "Draft").length, 0);

  const filteredPts = patients.filter(p =>
    p.name.toLowerCase().includes(ptSearch.toLowerCase()) ||
    p.mrn.toLowerCase().includes(ptSearch.toLowerCase())
  );

  const tabs = ["Summary", "Timeline", "Orders", "Results", "MAR", "Notes", "Imaging", "Disposition"];

  return (
    <div style={{ background: S.bg, color: S.textPri, height: "100vh", display: "flex", flexDirection: "column", fontFamily: "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif", fontSize: 13, overflow: "hidden" }}>
      {/* â”€â”€â”€ TOP HEADER â”€â”€â”€ */}
      <header style={{ background: "linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%)", borderBottom: `1px solid ${S.border}`, padding: "0 16px", display: "flex", alignItems: "center", gap: 16, minHeight: 52, flexShrink: 0 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          <span style={{ background: S.red, color: "#fff", fontWeight: 700, fontSize: 10, padding: "2px 8px", borderRadius: 4, letterSpacing: 1 }}>SIM</span>
          <span style={{ fontWeight: 700, fontSize: 16, color: S.cyan }}>SimEHR</span>
        </div>
        {pt && (
          <div style={{ display: "flex", alignItems: "center", gap: 16, flex: 1, minWidth: 0 }}>
            <div style={{ width: 1, height: 30, background: S.border }} />
            <div style={{ display: "flex", alignItems: "center", gap: 12, flex: 1, minWidth: 0 }}>
              <span style={{ fontWeight: 700, fontSize: 15, whiteSpace: "nowrap" }}>{pt.name}</span>
              <Pill bg={S.bgCard}>{pt.mrn}</Pill>
              <span style={{ color: S.textSec, whiteSpace: "nowrap" }}>DOB: {pt.dob} ({pt.age}{pt.sex})</span>
              <Pill bg={S.blueBg} color={S.cyan}>{pt.location}</Pill>
              <Pill bg={S.blueBg} color={S.textSec}>{pt.encounter}</Pill>
              {pt.allergies.length > 0 && <Pill bg={S.redBg} color={S.red}>âš  Allergies: {pt.allergies.map(a => a.agent).join(", ")}</Pill>}
              {pt.alerts.map((a, i) => <Pill key={i} bg={S.yellowBg} color={S.yellow}>{a}</Pill>)}
            </div>
          </div>
        )}
        <div style={{ display: "flex", alignItems: "center", gap: 8, flexShrink: 0 }}>
          <SelectSmall value={role} onChange={e => setRole(e.target.value)} options={["Provider", "RN", "Student"]} />
          <SelectSmall value={unit} onChange={e => setUnit(e.target.value)} options={["ED", "ICU", "Med/Surg", "Tele"]} />
        </div>
      </header>

      {/* â”€â”€â”€ MAIN BODY â”€â”€â”€ */}
      <div style={{ display: "flex", flex: 1, overflow: "hidden" }}>
        {/* LEFT SIDEBAR */}
        <aside style={{ width: sidebarOpen ? 240 : 40, background: S.bgCard, borderRight: `1px solid ${S.border}`, display: "flex", flexDirection: "column", transition: "width 0.2s", overflow: "hidden", flexShrink: 0 }}>
          <button onClick={() => setSidebarOpen(!sidebarOpen)} style={{ ...btnStyle, padding: "8px 10px", borderRadius: 0, borderBottom: `1px solid ${S.border}`, textAlign: "left", fontSize: 14 }}>
            {sidebarOpen ? "â—€ Patients" : "â–¶"}
          </button>
          {sidebarOpen && (
            <>
              <div style={{ padding: 8 }}>
                <input value={ptSearch} onChange={e => setPtSearch(e.target.value)} placeholder="Search patients..." style={{ ...inputStyle, width: "100%" }} />
              </div>
              <div style={{ flex: 1, overflow: "auto" }}>
                {filteredPts.map(p => (
                  <button key={p.id} onClick={() => { setSelPtId(p.id); log(`Opened chart: ${p.name}`); }}
                    style={{ ...btnStyle, display: "block", width: "100%", textAlign: "left", padding: "10px 12px",
                      background: p.id === selPtId ? S.blueBg : "transparent",
                      borderLeft: p.id === selPtId ? `3px solid ${S.blue}` : "3px solid transparent",
                      borderBottom: `1px solid ${S.border}` }}>
                    <div style={{ fontWeight: 600, fontSize: 12.5, marginBottom: 2 }}>{p.name}</div>
                    <div style={{ color: S.textMute, fontSize: 11 }}>{p.location} Â· {p.chief.substring(0, 30)}â€¦</div>
                  </button>
                ))}
              </div>
              {/* Activity Tiles */}
              <div style={{ borderTop: `1px solid ${S.border}`, padding: 8 }}>
                <div style={{ fontSize: 10, fontWeight: 600, color: S.textMute, marginBottom: 6, textTransform: "uppercase", letterSpacing: 1 }}>Activity</div>
                <ActivityTile icon="ðŸ“¬" label="In Basket" count={3} />
                <ActivityTile icon="ðŸ“‹" label="Tasks" count={7} />
                <ActivityTile icon="ðŸ”¬" label="New Results" count={unackCount} color={unackCount > 0 ? S.red : null} />
                <ActivityTile icon="âœï¸" label="Unsigned" count={unsignedCount} color={unsignedCount > 0 ? S.yellow : null} />
              </div>
            </>
          )}
        </aside>

        {/* CENTER WORKSPACE */}
        <main style={{ flex: 1, display: "flex", flexDirection: "column", overflow: "hidden", minWidth: 0 }}>
          {/* Tabs */}
          <nav style={{ display: "flex", borderBottom: `2px solid ${S.border}`, background: S.bgCard, flexShrink: 0, overflow: "auto" }}>
            {tabs.map(t => (
              <button key={t} onClick={() => { setTab(t); log(`Viewed tab: ${t}`); }}
                style={{ ...btnStyle, padding: "10px 18px", fontSize: 12.5, fontWeight: tab === t ? 700 : 400,
                  color: tab === t ? S.cyan : S.textSec,
                  borderBottom: tab === t ? `2px solid ${S.cyan}` : "2px solid transparent",
                  marginBottom: -2, whiteSpace: "nowrap",
                  position: "relative" }}>
                {t}
                {t === "Results" && unackCount > 0 && <Badge count={unackCount} />}
              </button>
            ))}
          </nav>
          {/* Tab Content */}
          <div style={{ flex: 1, overflow: "auto", padding: 16 }}>
            {pt && tab === "Summary" && <SummaryTab pt={pt} updatePt={updatePt} log={log} />}
            {pt && tab === "Timeline" && <TimelineTab pt={pt} audit={audit.filter(a => a.pt === pt.id)} />}
            {pt && tab === "Orders" && <OrdersTab pt={pt} updatePt={updatePt} log={log} />}
            {pt && tab === "Results" && <ResultsTab pt={pt} updatePt={updatePt} log={log} />}
            {pt && tab === "MAR" && <MARTab pt={pt} updatePt={updatePt} log={log} />}
            {pt && tab === "Notes" && <NotesTab pt={pt} updatePt={updatePt} log={log} />}
            {pt && tab === "Imaging" && <ImagingTab pt={pt} />}
            {pt && tab === "Disposition" && <DispositionTab pt={pt} log={log} />}
          </div>
        </main>

        {/* RIGHT SIDEBAR */}
        <aside style={{ width: rightOpen ? 260 : 40, background: S.bgCard, borderLeft: `1px solid ${S.border}`, display: "flex", flexDirection: "column", transition: "width 0.2s", overflow: "hidden", flexShrink: 0 }}>
          <button onClick={() => setRightOpen(!rightOpen)} style={{ ...btnStyle, padding: "8px 10px", borderRadius: 0, borderBottom: `1px solid ${S.border}`, textAlign: "right", fontSize: 14 }}>
            {rightOpen ? "Context â–¶" : "â—€"}
          </button>
          {rightOpen && pt && (
            <div style={{ flex: 1, overflow: "auto", padding: 10 }}>
              <SectionLabel>Encounter</SectionLabel>
              <div style={{ fontSize: 11.5, color: S.textSec, marginBottom: 4 }}>{pt.encounter}</div>
              <div style={{ fontSize: 11.5, color: S.textSec, marginBottom: 4 }}>{pt.location} Â· {pt.status}</div>
              <div style={{ fontSize: 11.5, color: S.textSec, marginBottom: 12 }}>Role: {role} Â· Unit: {unit}</div>

              <SectionLabel>Quick Actions</SectionLabel>
              <div style={{ display: "flex", flexDirection: "column", gap: 4, marginBottom: 12 }}>
                <SmallBtn onClick={() => { setTab("Notes"); log("Quick action: New Note"); }}>+ New Note</SmallBtn>
                <SmallBtn onClick={() => { setTab("Orders"); log("Quick action: New Order"); }}>+ New Order</SmallBtn>
                <SmallBtn onClick={() => {
                  setPatients(JSON.parse(JSON.stringify(PATIENTS)));
                  setAudit([]);
                  log("Reset all simulation data");
                }} color={S.red}>â†º Reset Sim Data</SmallBtn>
              </div>

              <SectionLabel>Audit Log</SectionLabel>
              <div style={{ maxHeight: 400, overflow: "auto" }}>
                {audit.filter(a => a.pt === pt.id).slice(0, 30).map((a, i) => (
                  <div key={i} style={{ fontSize: 10.5, padding: "4px 0", borderBottom: `1px solid ${S.border}`, color: S.textSec }}>
                    <span style={{ color: S.textMute }}>{a.time}</span> {a.action}
                  </div>
                ))}
                {audit.filter(a => a.pt === pt.id).length === 0 && <div style={{ fontSize: 11, color: S.textMute }}>No actions recorded yet.</div>}
              </div>
            </div>
          )}
        </aside>
      </div>
    </div>
  );
}

// â”€â”€â”€ TAB: SUMMARY â”€â”€â”€
function SummaryTab({ pt, updatePt, log }) {
  const [quickOrders, setQuickOrders] = useState({});
  const quickSet = [
    { id: "qs1", name: "CBC" }, { id: "qs2", name: "CMP" }, { id: "qs3", name: "Troponin" },
    { id: "qs4", name: "PT/INR" }, { id: "qs5", name: "UA" }, { id: "qs6", name: "EKG" },
    { id: "qs7", name: "CXR" }, { id: "qs8", name: "Lipase" }, { id: "qs9", name: "Lactate" }, { id: "qs10", name: "BNP" },
  ];

  const latestVitals = pt.vitals[pt.vitals.length - 1];

  return (
    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
      {/* Vitals */}
      <Card title="Vitals" span={2}>
        <div style={{ display: "flex", gap: 12, flexWrap: "wrap" }}>
          {latestVitals && <>
            <VitalBox label="HR" val={latestVitals.hr} unit="bpm" flag={latestVitals.hr > 100 ? "high" : latestVitals.hr < 60 ? "low" : null} />
            <VitalBox label="BP" val={latestVitals.bp} flag={parseInt(latestVitals.bp) > 140 || parseInt(latestVitals.bp) < 90 ? "high" : null} />
            <VitalBox label="RR" val={latestVitals.rr} unit="/min" flag={latestVitals.rr > 20 ? "high" : null} />
            <VitalBox label="SpOâ‚‚" val={latestVitals.spo2} unit="%" flag={latestVitals.spo2 < 95 ? "low" : null} />
            <VitalBox label="Temp" val={latestVitals.temp} unit="Â°F" flag={latestVitals.temp > 100.4 ? "high" : null} />
            <VitalBox label="Pain" val={latestVitals.pain} unit="/10" flag={latestVitals.pain >= 7 ? "high" : null} />
          </>}
        </div>
        <div style={{ fontSize: 10, color: S.textMute, marginTop: 6 }}>Latest at {latestVitals?.time} Â· {pt.vitals.length} sets recorded</div>
        {pt.vitals.length > 1 && (
          <div style={{ marginTop: 8 }}>
            <table style={tableStyle}>
              <thead><tr>
                <Th>Time</Th><Th>HR</Th><Th>BP</Th><Th>RR</Th><Th>SpOâ‚‚</Th><Th>Temp</Th><Th>Pain</Th>
              </tr></thead>
              <tbody>{pt.vitals.map((v, i) => (
                <tr key={i} style={{ background: i % 2 ? S.bgCard : "transparent" }}>
                  <Td>{v.time}</Td><Td>{v.hr}</Td><Td>{v.bp}</Td><Td>{v.rr}</Td><Td>{v.spo2}%</Td><Td>{v.temp}</Td><Td>{v.pain}</Td>
                </tr>
              ))}</tbody>
            </table>
          </div>
        )}
      </Card>

      {/* Allergies */}
      <Card title={`Allergies & Alerts`}>
        {pt.allergies.length === 0 ? <div style={{ color: S.green, fontSize: 12 }}>NKDA â€” No Known Drug Allergies</div> :
          pt.allergies.map((a, i) => (
            <div key={i} style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 4 }}>
              <Pill bg={a.severity === "High" ? S.redBg : S.yellowBg} color={a.severity === "High" ? S.red : S.yellow}>
                {a.severity === "High" ? "â›”" : "âš "} {a.agent}
              </Pill>
              <span style={{ fontSize: 11, color: S.textSec }}>{a.reaction}</span>
            </div>
          ))}
        {pt.alerts.map((a, i) => <Pill key={i} bg={S.yellowBg} color={S.yellow} style={{ marginTop: 4, marginRight: 4 }}>{a}</Pill>)}
      </Card>

      {/* Problem List */}
      <Card title="Problem List">
        {pt.problems.map((p, i) => (
          <div key={i} style={{ padding: "3px 0", fontSize: 12, borderBottom: `1px solid ${S.border}`, color: S.textSec }}>
            {i + 1}. {p}
          </div>
        ))}
      </Card>

      {/* Home Meds */}
      <Card title="Home Medications">
        {pt.homeMeds.map((m, i) => (
          <div key={i} style={{ padding: "3px 0", fontSize: 12, borderBottom: `1px solid ${S.border}` }}>
            <span style={{ color: S.textPri }}>{m.name}</span>
            <span style={{ color: S.textMute, marginLeft: 8 }}>{m.route} {m.freq}</span>
          </div>
        ))}
      </Card>

      {/* Inpatient Meds */}
      <Card title="Active Inpatient Medications">
        {pt.inptMeds.map((m, i) => (
          <div key={i} style={{ padding: "3px 0", fontSize: 12, borderBottom: `1px solid ${S.border}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <span>{m.name} <span style={{ color: S.textMute }}>{m.route} {m.freq}</span></span>
            <StatusPill status={m.status} />
          </div>
        ))}
      </Card>

      {/* Quick Order Set */}
      <Card title="Quick Order Set" span={2}>
        <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginBottom: 8 }}>
          {quickSet.map(q => (
            <label key={q.id} style={{ display: "flex", alignItems: "center", gap: 4, cursor: "pointer", padding: "4px 10px", background: quickOrders[q.id] ? S.blueBg : S.bgInput, border: `1px solid ${quickOrders[q.id] ? S.blue : S.border}`, borderRadius: 6, fontSize: 12, transition: "all 0.15s" }}>
              <input type="checkbox" checked={!!quickOrders[q.id]} onChange={() => setQuickOrders(o => ({ ...o, [q.id]: !o[q.id] }))}
                style={{ accentColor: S.blue }} />
              {q.name}
            </label>
          ))}
        </div>
        <button onClick={() => {
          const sel = quickSet.filter(q => quickOrders[q.id]);
          if (sel.length === 0) return;
          log(`Quick ordered: ${sel.map(s => s.name).join(", ")}`);
          setQuickOrders({});
          alert(`âœ“ ${sel.length} order(s) placed: ${sel.map(s => s.name).join(", ")}`);
        }} style={{ ...primaryBtnStyle }}>Place Selected Orders</button>
      </Card>

      {/* ED Course */}
      <Card title="ED Course / Clinical Notes" span={2}>
        <textarea value={pt.edCourse} onChange={e => updatePt(pt.id, p => { p.edCourse = e.target.value; return p; })}
          placeholder="Document the ED course here... (autosaves)"
          style={{ ...inputStyle, width: "100%", minHeight: 100, resize: "vertical", fontFamily: "inherit" }} />
        <div style={{ fontSize: 10, color: S.textMute, marginTop: 4 }}>Auto-saves to patient record</div>
      </Card>
    </div>
  );
}

// â”€â”€â”€ TAB: TIMELINE â”€â”€â”€
function TimelineTab({ pt, audit }) {
  const [filter, setFilter] = useState("");
  const events = useMemo(() => {
    const ev = [];
    pt.vitals.forEach((v, i) => ev.push({ time: v.time, type: "Vitals", desc: `HR ${v.hr} | BP ${v.bp} | SpOâ‚‚ ${v.spo2}% | T ${v.temp}Â°F`, cat: "vitals" }));
    pt.results.forEach(r => ev.push({ time: r.time, type: r.cat, desc: `${r.name}: ${r.value} ${r.unit || ""} ${r.flag !== "NORMAL" && r.flag !== "PENDING" ? `[${r.flag}]` : ""}`, cat: "result" }));
    pt.inptMeds.forEach(m => ev.push({ time: m.lastGiven || "--:--", type: "Medication", desc: `${m.name} (${m.status})`, cat: "med" }));
    (pt.notes || []).forEach(n => ev.push({ time: n.time, type: "Note", desc: `${n.type} â€” ${n.status}`, cat: "note" }));
    audit.forEach(a => ev.push({ time: a.time, type: "Action", desc: a.action, cat: "action" }));
    return ev.filter(e => !filter || e.desc.toLowerCase().includes(filter.toLowerCase()) || e.type.toLowerCase().includes(filter.toLowerCase()));
  }, [pt, audit, filter]);

  const catColors = { vitals: S.cyan, result: S.blue, med: S.green, note: S.purple, action: S.textMute };

  return (
    <div>
      <div style={{ marginBottom: 12 }}>
        <input value={filter} onChange={e => setFilter(e.target.value)} placeholder="Filter timeline..." style={{ ...inputStyle, width: 300 }} />
      </div>
      <div style={{ position: "relative", paddingLeft: 20 }}>
        <div style={{ position: "absolute", left: 8, top: 0, bottom: 0, width: 2, background: S.border }} />
        {events.map((e, i) => (
          <div key={i} style={{ position: "relative", marginBottom: 8, paddingLeft: 20 }}>
            <div style={{ position: "absolute", left: -16, top: 6, width: 10, height: 10, borderRadius: "50%", background: catColors[e.cat] || S.textMute, border: `2px solid ${S.bgCard}` }} />
            <div style={{ background: S.bgCard, border: `1px solid ${S.border}`, borderRadius: 8, padding: "8px 12px" }}>
              <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 2 }}>
                <Pill bg={catColors[e.cat] + "22"} color={catColors[e.cat]}>{e.type}</Pill>
                <span style={{ fontSize: 11, color: S.textMute }}>{e.time}</span>
              </div>
              <div style={{ fontSize: 12, color: S.textSec }}>{e.desc}</div>
            </div>
          </div>
        ))}
        {events.length === 0 && <div style={{ color: S.textMute, padding: 20 }}>No timeline events match your filter.</div>}
      </div>
    </div>
  );
}

// â”€â”€â”€ TAB: ORDERS â”€â”€â”€
function OrdersTab({ pt, updatePt, log }) {
  const [search, setSearch] = useState("");
  const [cart, setCart] = useState([]);
  const [catFilter, setCatFilter] = useState("All");
  const [orders, setOrders] = useState([]);

  const filtered = ORDER_CATALOG.filter(o =>
    (catFilter === "All" || o.cat === catFilter) &&
    (o.name.toLowerCase().includes(search.toLowerCase()) || o.sub.toLowerCase().includes(search.toLowerCase()))
  );

  const addToCart = (item) => { if (!cart.find(c => c.id === item.id)) setCart([...cart, { ...item, priority: "Routine", note: "" }]); };
  const removeFromCart = (id) => setCart(cart.filter(c => c.id !== id));

  const placeOrders = () => {
    if (cart.length === 0) return;
    const newOrds = cart.map(c => ({
      id: `ORD-${Date.now()}-${Math.random().toString(36).substr(2, 4)}`,
      name: c.name, cat: c.cat, priority: c.priority, status: "Unsigned",
      time: now(), note: c.note
    }));
    setOrders(o => [...newOrds, ...o]);
    log(`Placed ${cart.length} order(s): ${cart.map(c => c.name).join(", ")}`);
    setCart([]);
  };

  const advanceOrder = (id) => {
    const seq = ["Unsigned", "Signed", "Collected", "Processing", "Completed"];
    setOrders(os => os.map(o => {
      if (o.id !== id) return o;
      const idx = seq.indexOf(o.status);
      if (idx < seq.length - 1) {
        log(`Order ${o.name}: ${o.status} â†’ ${seq[idx + 1]}`);
        return { ...o, status: seq[idx + 1] };
      }
      return o;
    }));
  };

  const cancelOrder = (id) => {
    setOrders(os => os.map(o => o.id === id ? { ...o, status: "Cancelled" } : o));
    const ord = orders.find(o => o.id === id);
    if (ord) log(`Cancelled order: ${ord.name}`);
  };

  const cats = ["All", "Lab", "Imaging", "Medication", "Diagnostic", "Nursing"];

  return (
    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
      {/* Catalog */}
      <Card title="Order Catalog">
        <div style={{ display: "flex", gap: 4, marginBottom: 8, flexWrap: "wrap" }}>
          {cats.map(c => (
            <button key={c} onClick={() => setCatFilter(c)}
              style={{ ...btnStyle, padding: "3px 10px", fontSize: 11, background: catFilter === c ? S.blue : S.bgInput, color: catFilter === c ? "#fff" : S.textSec, borderRadius: 20 }}>
              {c}
            </button>
          ))}
        </div>
        <input value={search} onChange={e => setSearch(e.target.value)} placeholder="Search orders..." style={{ ...inputStyle, width: "100%", marginBottom: 8 }} />
        <div style={{ maxHeight: 350, overflow: "auto" }}>
          {filtered.map(o => (
            <div key={o.id} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "5px 0", borderBottom: `1px solid ${S.border}`, fontSize: 12 }}>
              <div>
                <span>{o.name}</span>
                <span style={{ color: S.textMute, marginLeft: 8, fontSize: 10 }}>{o.sub}</span>
              </div>
              <button onClick={() => addToCart(o)} style={{ ...btnStyle, padding: "2px 10px", background: S.blueBg, color: S.blue, borderRadius: 4, fontSize: 11 }}>+ Add</button>
            </div>
          ))}
        </div>
      </Card>

      {/* Cart + Placed Orders */}
      <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
        <Card title={`Order Cart (${cart.length})`}>
          {cart.length === 0 ? <div style={{ color: S.textMute, fontSize: 12 }}>No orders in cart. Add from catalog.</div> :
            <>
              {cart.map(c => (
                <div key={c.id} style={{ padding: "6px 0", borderBottom: `1px solid ${S.border}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                  <div style={{ fontSize: 12 }}>
                    <div>{c.name}</div>
                    <select value={c.priority} onChange={e => setCart(cart.map(x => x.id === c.id ? { ...x, priority: e.target.value } : x))}
                      style={{ ...inputStyle, fontSize: 10, padding: "1px 4px", marginTop: 2 }}>
                      <option>Routine</option><option>STAT</option><option>Urgent</option>
                    </select>
                  </div>
                  <button onClick={() => removeFromCart(c.id)} style={{ ...btnStyle, color: S.red, fontSize: 18, padding: "0 4px" }}>Ã—</button>
                </div>
              ))}
              <button onClick={placeOrders} style={{ ...primaryBtnStyle, marginTop: 8, width: "100%" }}>
                Place {cart.length} Order{cart.length > 1 ? "s" : ""}
              </button>
            </>
          }
        </Card>

        <Card title="Placed Orders">
          {orders.length === 0 ? <div style={{ color: S.textMute, fontSize: 12 }}>No orders placed this session.</div> :
            <div style={{ maxHeight: 300, overflow: "auto" }}>
              <table style={tableStyle}>
                <thead><tr><Th>Order</Th><Th>Priority</Th><Th>Status</Th><Th>Actions</Th></tr></thead>
                <tbody>
                  {orders.map(o => (
                    <tr key={o.id} style={{ opacity: o.status === "Cancelled" ? 0.4 : 1 }}>
                      <Td><div style={{ fontSize: 12 }}>{o.name}</div><div style={{ fontSize: 10, color: S.textMute }}>{o.time}</div></Td>
                      <Td><Pill bg={o.priority === "STAT" ? S.redBg : S.bgInput} color={o.priority === "STAT" ? S.red : S.textSec}>{o.priority}</Pill></Td>
                      <Td><StatusPill status={o.status} /></Td>
                      <Td>
                        {o.status !== "Completed" && o.status !== "Cancelled" && (
                          <div style={{ display: "flex", gap: 4 }}>
                            <button onClick={() => advanceOrder(o.id)} style={{ ...btnStyle, fontSize: 10, padding: "2px 6px", background: S.blueBg, color: S.blue, borderRadius: 4 }}>Advance â–¸</button>
                            <button onClick={() => cancelOrder(o.id)} style={{ ...btnStyle, fontSize: 10, padding: "2px 6px", color: S.red }}>Cancel</button>
                          </div>
                        )}
                      </Td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          }
        </Card>
      </div>
    </div>
  );
}

// â”€â”€â”€ TAB: RESULTS â”€â”€â”€
function ResultsTab({ pt, updatePt, log }) {
  const [filter, setFilter] = useState("All");
  const [search, setSearch] = useState("");
  const [trendItem, setTrendItem] = useState(null);

  const filters = ["All", "Abnormal", "Critical", "Pending", "Lab", "Imaging"];

  const filtered = pt.results.filter(r => {
    if (filter === "Abnormal") return r.flag !== "NORMAL" && r.flag !== "PENDING";
    if (filter === "Critical") return r.flag === "CRITICAL";
    if (filter === "Pending") return r.flag === "PENDING";
    if (filter === "Lab") return r.cat === "Lab";
    if (filter === "Imaging") return r.cat === "Imaging";
    return true;
  }).filter(r => !search || r.name.toLowerCase().includes(search.toLowerCase()));

  const ack = (id) => {
    updatePt(pt.id, p => { p.results = p.results.map(r => r.id === id ? { ...r, ack: true } : r); return p; });
    log(`Acknowledged result: ${pt.results.find(r => r.id === id)?.name}`);
  };

  const ackAll = () => {
    updatePt(pt.id, p => { p.results = p.results.map(r => ({ ...r, ack: true })); return p; });
    log("Acknowledged all results");
  };

  // Find trendable items (same name, multiple results)
  const trendable = useMemo(() => {
    const names = {};
    pt.results.forEach(r => { if (r.value && !isNaN(parseFloat(r.value))) { names[r.name] = (names[r.name] || 0) + 1; } });
    return Object.keys(names).filter(n => names[n] > 1);
  }, [pt.results]);

  const trendData = trendItem ? pt.results.filter(r => r.name === trendItem).map(r => ({ time: r.time, value: parseFloat(r.value) })) : [];

  return (
    <div>
      <div style={{ display: "flex", gap: 8, marginBottom: 12, alignItems: "center", flexWrap: "wrap" }}>
        {filters.map(f => (
          <button key={f} onClick={() => setFilter(f)}
            style={{ ...btnStyle, padding: "4px 12px", fontSize: 11, background: filter === f ? S.blue : S.bgCard, color: filter === f ? "#fff" : S.textSec, borderRadius: 20, border: `1px solid ${filter === f ? S.blue : S.border}` }}>
            {f}
          </button>
        ))}
        <input value={search} onChange={e => setSearch(e.target.value)} placeholder="Search results..." style={{ ...inputStyle, marginLeft: "auto" }} />
        <button onClick={ackAll} style={{ ...primaryBtnStyle, fontSize: 11 }}>âœ“ Acknowledge All</button>
      </div>

      {trendable.length > 0 && (
        <div style={{ marginBottom: 12, display: "flex", gap: 6, alignItems: "center", flexWrap: "wrap" }}>
          <span style={{ fontSize: 11, color: S.textMute }}>Trends:</span>
          {trendable.map(t => (
            <button key={t} onClick={() => setTrendItem(trendItem === t ? null : t)}
              style={{ ...btnStyle, padding: "2px 8px", fontSize: 10, background: trendItem === t ? S.blueBg : S.bgCard, color: trendItem === t ? S.cyan : S.textSec, borderRadius: 4, border: `1px solid ${S.border}` }}>
              ðŸ“ˆ {t}
            </button>
          ))}
        </div>
      )}

      {trendItem && trendData.length > 0 && (
        <Card title={`Trend: ${trendItem}`} style={{ marginBottom: 12 }}>
          <div style={{ display: "flex", gap: 20, alignItems: "flex-end", height: 80, padding: "8px 0" }}>
            {trendData.map((d, i) => {
              const max = Math.max(...trendData.map(x => x.value));
              const h = max > 0 ? (d.value / max) * 60 : 10;
              return (
                <div key={i} style={{ display: "flex", flexDirection: "column", alignItems: "center", gap: 4 }}>
                  <span style={{ fontSize: 11, fontWeight: 700, color: S.red }}>{d.value}</span>
                  <div style={{ width: 30, height: h, background: `linear-gradient(to top, ${S.red}, ${S.orange})`, borderRadius: 4 }} />
                  <span style={{ fontSize: 10, color: S.textMute }}>{d.time}</span>
                </div>
              );
            })}
          </div>
        </Card>
      )}

      <table style={tableStyle}>
        <thead>
          <tr><Th>Test</Th><Th>Value</Th><Th>Reference</Th><Th>Flag</Th><Th>Time</Th><Th>Status</Th><Th></Th></tr>
        </thead>
        <tbody>
          {filtered.map(r => (
            <tr key={r.id} style={{ background: r.flag === "CRITICAL" ? S.redBg + "44" : r.flag === "HIGH" || r.flag === "LOW" || r.flag === "ABNORMAL" ? S.yellowBg + "22" : "transparent" }}>
              <Td style={{ fontWeight: 600 }}>{r.name}</Td>
              <Td>
                <span style={{ color: r.flag === "CRITICAL" ? S.red : r.flag === "NORMAL" || r.flag === "PENDING" ? S.textPri : S.yellow, fontWeight: r.flag === "CRITICAL" ? 700 : 400 }}>
                  {r.value}
                </span>
                {r.unit && <span style={{ color: S.textMute, marginLeft: 4 }}>{r.unit}</span>}
              </Td>
              <Td style={{ color: S.textMute }}>{r.ref || "â€”"}</Td>
              <Td><FlagPill flag={r.flag} /></Td>
              <Td style={{ color: S.textMute }}>{r.time}</Td>
              <Td>{r.ack ? <span style={{ color: S.green, fontSize: 11 }}>âœ“ Ack</span> : <span style={{ color: S.yellow, fontSize: 11 }}>New</span>}</Td>
              <Td>
                {!r.ack && <button onClick={() => ack(r.id)} style={{ ...btnStyle, fontSize: 10, padding: "2px 8px", background: S.blueBg, color: S.blue, borderRadius: 4 }}>Ack</button>}
                {r.report && <button onClick={() => alert(r.report)} style={{ ...btnStyle, fontSize: 10, padding: "2px 8px", color: S.cyan, marginLeft: 4 }}>ðŸ“„ Report</button>}
              </Td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}

// â”€â”€â”€ TAB: MAR â”€â”€â”€
function MARTab({ pt, updatePt, log }) {
  const [filter, setFilter] = useState("All");
  const [selected, setSelected] = useState({});

  const filtered = pt.inptMeds.filter(m => {
    if (filter === "Due") return m.status === "Due" || m.status === "Running";
    if (filter === "PRN") return m.sched === "PRN";
    if (filter === "Given") return m.status === "Given";
    return true;
  });

  const administerSelected = () => {
    const ids = Object.keys(selected).filter(k => selected[k]);
    if (ids.length === 0) return;
    updatePt(pt.id, p => {
      p.inptMeds = p.inptMeds.map(m => ids.includes(m.id) ? { ...m, status: "Given", lastGiven: now() } : m);
      return p;
    });
    const names = pt.inptMeds.filter(m => ids.includes(m.id)).map(m => m.name);
    log(`Administered: ${names.join(", ")}`);
    setSelected({});
  };

  return (
    <div>
      <div style={{ display: "flex", gap: 8, marginBottom: 12, alignItems: "center" }}>
        {["All", "Due", "PRN", "Given"].map(f => (
          <button key={f} onClick={() => setFilter(f)}
            style={{ ...btnStyle, padding: "4px 12px", fontSize: 11, background: filter === f ? S.blue : S.bgCard, color: filter === f ? "#fff" : S.textSec, borderRadius: 20, border: `1px solid ${filter === f ? S.blue : S.border}` }}>
            {f}
          </button>
        ))}
        <button onClick={administerSelected} style={{ ...primaryBtnStyle, fontSize: 11, marginLeft: "auto" }}>
          ðŸ’‰ Administer Selected
        </button>
      </div>

      <table style={tableStyle}>
        <thead><tr><Th></Th><Th>Medication</Th><Th>Route</Th><Th>Frequency</Th><Th>Schedule</Th><Th>Status</Th><Th>Last Given</Th></tr></thead>
        <tbody>
          {filtered.map(m => (
            <tr key={m.id} style={{ background: m.status === "Due" ? S.yellowBg + "22" : m.status === "Running" ? S.blueBg + "44" : "transparent" }}>
              <Td><input type="checkbox" checked={!!selected[m.id]} onChange={() => setSelected(s => ({ ...s, [m.id]: !s[m.id] }))}
                disabled={m.status === "Given"} style={{ accentColor: S.blue }} /></Td>
              <Td style={{ fontWeight: 600 }}>{m.name}</Td>
              <Td>{m.route}</Td>
              <Td>{m.freq}</Td>
              <Td><Pill bg={m.sched === "PRN" ? S.bgInput : m.sched === "STAT" ? S.redBg : S.blueBg}
                color={m.sched === "PRN" ? S.textSec : m.sched === "STAT" ? S.red : S.cyan}>{m.sched}</Pill></Td>
              <Td><StatusPill status={m.status} /></Td>
              <Td style={{ color: S.textMute }}>{m.lastGiven || "â€”"}</Td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}

// â”€â”€â”€ TAB: NOTES â”€â”€â”€
function NotesTab({ pt, updatePt, log }) {
  const [template, setTemplate] = useState("");
  const [noteType, setNoteType] = useState("ED Provider Note");
  const [content, setContent] = useState("");
  const [showSP, setShowSP] = useState(false);

  const applyTemplate = (t) => {
    setNoteType(t);
    let text = NOTE_TEMPLATES[t] || "";
    // Auto-fill some fields
    text = text.replace("[complaint]", pt.chief).replace("[name]", pt.name).replace("[mrn]", pt.mrn)
      .replace("[age]", pt.age + "").replace("[sex]", pt.sex).replace("[problems]", pt.problems.join(", "));
    setContent(text);
  };

  const insertSP = (key) => {
    setContent(c => c + " " + SMART_PHRASES[key]);
    setShowSP(false);
  };

  const saveNote = (status) => {
    if (!content.trim()) return;
    updatePt(pt.id, p => {
      p.notes = [...(p.notes || []), { id: `N-${Date.now()}`, type: noteType, content, status, time: now(), author: "Sim Provider" }];
      return p;
    });
    log(`${status === "Draft" ? "Saved draft" : "Signed"} ${noteType}`);
    setContent("");
  };

  return (
    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
      {/* Note Writer */}
      <Card title="Note Writer">
        <div style={{ display: "flex", gap: 8, marginBottom: 8, flexWrap: "wrap" }}>
          {Object.keys(NOTE_TEMPLATES).map(t => (
            <button key={t} onClick={() => applyTemplate(t)}
              style={{ ...btnStyle, padding: "3px 10px", fontSize: 11, background: noteType === t ? S.blueBg : S.bgInput, color: noteType === t ? S.cyan : S.textSec, borderRadius: 4, border: `1px solid ${S.border}` }}>
              {t}
            </button>
          ))}
        </div>

        <div style={{ position: "relative" }}>
          <textarea value={content} onChange={e => setContent(e.target.value)}
            placeholder="Start typing or select a template..."
            style={{ ...inputStyle, width: "100%", minHeight: 320, resize: "vertical", fontFamily: "'Courier New', monospace", fontSize: 12, lineHeight: 1.5 }} />
        </div>

        <div style={{ display: "flex", gap: 8, marginTop: 8, alignItems: "center" }}>
          <button onClick={() => saveNote("Draft")} style={{ ...btnStyle, padding: "6px 16px", background: S.bgInput, color: S.yellow, border: `1px solid ${S.yellow}`, borderRadius: 6, fontSize: 12 }}>Save Draft</button>
          <button onClick={() => saveNote("Signed")} style={{ ...primaryBtnStyle }}>Sign Note</button>
          <button onClick={() => setShowSP(!showSP)} style={{ ...btnStyle, padding: "6px 12px", background: S.bgInput, color: S.purple, border: `1px solid ${S.purple}`, borderRadius: 6, fontSize: 12, marginLeft: "auto" }}>
            .SmartPhrases
          </button>
        </div>

        {showSP && (
          <div style={{ marginTop: 8, background: S.bgInput, border: `1px solid ${S.purple}`, borderRadius: 8, padding: 10 }}>
            <div style={{ fontSize: 11, color: S.purple, fontWeight: 600, marginBottom: 6 }}>SmartPhrases â€” Click to insert</div>
            {Object.entries(SMART_PHRASES).map(([k, v]) => (
              <button key={k} onClick={() => insertSP(k)}
                style={{ ...btnStyle, display: "block", width: "100%", textAlign: "left", padding: "4px 8px", marginBottom: 2, borderRadius: 4, fontSize: 11 }}>
                <span style={{ color: S.purple, fontWeight: 600, fontFamily: "monospace" }}>{k}</span>
                <span style={{ color: S.textMute, marginLeft: 8 }}>{v}</span>
              </button>
            ))}
          </div>
        )}
      </Card>

      {/* Notes List */}
      <Card title="Saved Notes">
        {(!pt.notes || pt.notes.length === 0) ? <div style={{ color: S.textMute, fontSize: 12 }}>No notes written yet.</div> :
          pt.notes.slice().reverse().map(n => (
            <div key={n.id} style={{ marginBottom: 10, background: S.bgInput, border: `1px solid ${S.border}`, borderRadius: 8, padding: 10 }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 4 }}>
                <div>
                  <span style={{ fontWeight: 600, fontSize: 12 }}>{n.type}</span>
                  <StatusPill status={n.status} style={{ marginLeft: 8 }} />
                </div>
                <span style={{ fontSize: 10, color: S.textMute }}>{n.time} Â· {n.author}</span>
              </div>
              <pre style={{ fontSize: 11, color: S.textSec, whiteSpace: "pre-wrap", fontFamily: "'Courier New', monospace", maxHeight: 150, overflow: "auto", margin: 0 }}>
                {n.content.substring(0, 500)}{n.content.length > 500 ? "..." : ""}
              </pre>
            </div>
          ))
        }
      </Card>
    </div>
  );
}

// â”€â”€â”€ TAB: IMAGING â”€â”€â”€
function ImagingTab({ pt }) {
  const [selImg, setSelImg] = useState(null);
  return (
    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
      <Card title="Imaging Orders">
        {pt.imaging.length === 0 ? <div style={{ color: S.textMute, fontSize: 12 }}>No imaging orders.</div> :
          pt.imaging.map(im => (
            <button key={im.id} onClick={() => setSelImg(im)}
              style={{ ...btnStyle, display: "block", width: "100%", textAlign: "left", padding: "10px 12px", marginBottom: 6, background: selImg?.id === im.id ? S.blueBg : S.bgInput, border: `1px solid ${selImg?.id === im.id ? S.blue : S.border}`, borderRadius: 8 }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                <span style={{ fontWeight: 600, fontSize: 12.5 }}>{im.name}</span>
                <StatusPill status={im.status} />
              </div>
              <div style={{ fontSize: 11, color: S.textMute, marginTop: 2 }}>Ordered: {im.time}</div>
            </button>
          ))
        }

        {/* Also show imaging results */}
        <div style={{ marginTop: 12 }}>
          <SectionLabel>Imaging Results</SectionLabel>
          {pt.results.filter(r => r.cat === "Imaging").map(r => (
            <div key={r.id} style={{ padding: "6px 0", borderBottom: `1px solid ${S.border}`, fontSize: 12 }}>
              <div style={{ fontWeight: 600 }}>{r.name}</div>
              <div style={{ color: S.textSec, marginTop: 2 }}>{r.value}</div>
              <FlagPill flag={r.flag} />
            </div>
          ))}
        </div>
      </Card>

      <Card title="Report Viewer">
        {selImg ? (
          <div>
            <div style={{ fontWeight: 700, fontSize: 14, marginBottom: 8 }}>{selImg.name}</div>
            <div style={{ display: "flex", gap: 8, marginBottom: 12 }}>
              <Pill bg={S.blueBg} color={S.cyan}>{selImg.status}</Pill>
              <span style={{ fontSize: 11, color: S.textMute }}>Time: {selImg.time}</span>
            </div>
            {selImg.report ? (
              <>
                <div style={{ background: "#000", borderRadius: 8, height: 180, display: "flex", alignItems: "center", justifyContent: "center", marginBottom: 12, border: `1px solid ${S.border}` }}>
                  <span style={{ color: S.textMute, fontSize: 12 }}>[ DICOM Viewer Placeholder â€” MVP ]</span>
                </div>
                <SectionLabel>Radiology Report</SectionLabel>
                <pre style={{ fontSize: 12, color: S.textSec, whiteSpace: "pre-wrap", fontFamily: "'Courier New', monospace", background: S.bgInput, padding: 12, borderRadius: 8, border: `1px solid ${S.border}` }}>
                  {selImg.report}
                </pre>
              </>
            ) : (
              <div style={{ color: S.yellow, fontSize: 12, padding: 20, textAlign: "center" }}>â³ Study pending â€” report not yet available.</div>
            )}
          </div>
        ) : (
          <div style={{ color: S.textMute, fontSize: 12, padding: 40, textAlign: "center" }}>Select an imaging study to view the report.</div>
        )}
      </Card>
    </div>
  );
}

// â”€â”€â”€ TAB: DISPOSITION â”€â”€â”€
function DispositionTab({ pt, log }) {
  const [dispo, setDispo] = useState("");
  const [dx, setDx] = useState("");
  const [service, setService] = useState("");
  const [followUp, setFollowUp] = useState("");
  const [instructions, setInstructions] = useState("");
  const [checklist, setChecklist] = useState({ medsReconciled: false, resultsReviewed: false, safetyScreen: false, patientEducated: false, followUpScheduled: false });
  const [showAVS, setShowAVS] = useState(false);

  const allChecked = Object.values(checklist).every(v => v);

  const generateAVS = () => {
    if (!dispo || !dx) { alert("Please select a disposition and enter a diagnosis."); return; }
    setShowAVS(true);
    log(`Generated AVS â€” Disposition: ${dispo}, Dx: ${dx}`);
  };

  return (
    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
      <Card title="Disposition Planning">
        <SectionLabel>Disposition</SectionLabel>
        <div style={{ display: "flex", gap: 8, marginBottom: 12, flexWrap: "wrap" }}>
          {["Discharge", "Admit", "Observation", "Transfer", "AMA", "Deceased"].map(d => (
            <button key={d} onClick={() => { setDispo(d); log(`Selected disposition: ${d}`); }}
              style={{ ...btnStyle, padding: "6px 16px", fontSize: 12, background: dispo === d ? S.blue : S.bgInput,
                color: dispo === d ? "#fff" : S.textSec, borderRadius: 8, border: `1px solid ${dispo === d ? S.blue : S.border}` }}>
              {d}
            </button>
          ))}
        </div>

        <SectionLabel>Diagnosis</SectionLabel>
        <input value={dx} onChange={e => setDx(e.target.value)} placeholder="Primary discharge/admit diagnosis..."
          style={{ ...inputStyle, width: "100%", marginBottom: 12 }} />

        {(dispo === "Admit" || dispo === "Observation") && (
          <>
            <SectionLabel>Admitting Service</SectionLabel>
            <select value={service} onChange={e => setService(e.target.value)} style={{ ...inputStyle, width: "100%", marginBottom: 12 }}>
              <option value="">Select service...</option>
              <option>Internal Medicine</option><option>Cardiology</option><option>Surgery â€” General</option>
              <option>Orthopedics</option><option>Neurology</option><option>Pulmonology/Critical Care</option><option>Hospitalist</option>
            </select>
          </>
        )}

        <SectionLabel>Follow-Up</SectionLabel>
        <input value={followUp} onChange={e => setFollowUp(e.target.value)} placeholder="PCP in 3 days, Cardiology in 1 week..."
          style={{ ...inputStyle, width: "100%", marginBottom: 12 }} />

        <SectionLabel>Patient Instructions</SectionLabel>
        <textarea value={instructions} onChange={e => setInstructions(e.target.value)}
          placeholder="Return precautions, medication changes, activity restrictions..."
          style={{ ...inputStyle, width: "100%", minHeight: 80, resize: "vertical", marginBottom: 12 }} />

        <button onClick={generateAVS} style={{ ...primaryBtnStyle, width: "100%" }}>Generate AVS Preview</button>
      </Card>

      <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
        {/* Safety Checklist */}
        <Card title="Safety Checklist / Hard Stops">
          {Object.entries(checklist).map(([k, v]) => {
            const labels = { medsReconciled: "Medications Reconciled", resultsReviewed: "All Results Reviewed", safetyScreen: "Safety Screening Complete", patientEducated: "Patient/Family Educated", followUpScheduled: "Follow-Up Confirmed" };
            return (
              <label key={k} style={{ display: "flex", alignItems: "center", gap: 8, padding: "6px 0", cursor: "pointer", borderBottom: `1px solid ${S.border}` }}>
                <input type="checkbox" checked={v} onChange={() => setChecklist(c => ({ ...c, [k]: !c[k] }))} style={{ accentColor: S.green, width: 16, height: 16 }} />
                <span style={{ color: v ? S.green : S.yellow, fontSize: 12 }}>{v ? "âœ“" : "âš "} {labels[k]}</span>
              </label>
            );
          })}
          <div style={{ marginTop: 8, padding: "8px 12px", background: allChecked ? S.greenBg : S.yellowBg, borderRadius: 6, fontSize: 12, color: allChecked ? S.green : S.yellow }}>
            {allChecked ? "âœ“ All safety checks complete â€” clear to finalize disposition." : "âš  Complete all safety checks before finalizing disposition."}
          </div>
        </Card>

        {/* AVS Preview */}
        {showAVS && (
          <Card title="After-Visit Summary (AVS) Preview">
            <div style={{ background: "#fff", color: "#000", padding: 16, borderRadius: 8, fontSize: 12, fontFamily: "serif" }}>
              <div style={{ textAlign: "center", fontWeight: 700, fontSize: 16, marginBottom: 8, borderBottom: "2px solid #000", paddingBottom: 8 }}>
                SIMULATED HEALTH SYSTEM<br />
                <span style={{ fontSize: 12, fontWeight: 400 }}>After-Visit Summary</span>
              </div>
              <div style={{ marginBottom: 8 }}>
                <strong>Patient:</strong> {pt.name} | <strong>MRN:</strong> {pt.mrn} | <strong>DOB:</strong> {pt.dob}<br />
                <strong>Visit Date:</strong> {new Date().toLocaleDateString()} | <strong>Location:</strong> {pt.location}
              </div>
              <div style={{ marginBottom: 8 }}>
                <strong>Disposition:</strong> {dispo}<br />
                <strong>Diagnosis:</strong> {dx}<br />
                {service && <><strong>Service:</strong> {service}<br /></>}
              </div>
              <div style={{ marginBottom: 8 }}>
                <strong>Follow-Up:</strong><br />{followUp || "As directed by your provider."}
              </div>
              <div style={{ marginBottom: 8 }}>
                <strong>Instructions:</strong><br />{instructions || "Follow up with your primary care provider."}
              </div>
              <div style={{ marginBottom: 8 }}>
                <strong>Current Medications:</strong>
                {pt.homeMeds.map((m, i) => <div key={i} style={{ marginLeft: 10 }}>â€¢ {m.name} â€” {m.route} {m.freq}</div>)}
              </div>
              <div style={{ marginTop: 12, borderTop: "1px solid #ccc", paddingTop: 8, fontSize: 10, color: "#666" }}>
                âš  SIMULATED DOCUMENT â€” NOT FOR CLINICAL USE â€” SimEHR Training Environment
              </div>
            </div>
          </Card>
        )}
      </div>
    </div>
  );
}

// â”€â”€â”€ SHARED COMPONENTS â”€â”€â”€
function Card({ title, children, span, style: st }) {
  return (
    <div style={{ background: S.bgCard, border: `1px solid ${S.border}`, borderRadius: 10, padding: 14, gridColumn: span === 2 ? "1 / -1" : undefined, ...st }}>
      {title && <div style={{ fontWeight: 700, fontSize: 13, marginBottom: 10, color: S.textPri, display: "flex", alignItems: "center", gap: 6 }}>{title}</div>}
      {children}
    </div>
  );
}

function Pill({ children, bg, color, style: st }) {
  return <span style={{ display: "inline-block", padding: "2px 8px", borderRadius: 20, fontSize: 11, background: bg || S.bgCard, color: color || S.textSec, whiteSpace: "nowrap", ...st }}>{children}</span>;
}

function VitalBox({ label, val, unit, flag }) {
  const bg = flag === "high" ? S.redBg : flag === "low" ? S.yellowBg : S.bgInput;
  const col = flag === "high" ? S.red : flag === "low" ? S.yellow : S.textPri;
  return (
    <div style={{ background: bg, border: `1px solid ${flag ? col + "44" : S.border}`, borderRadius: 8, padding: "8px 14px", minWidth: 80, textAlign: "center" }}>
      <div style={{ fontSize: 10, color: S.textMute, marginBottom: 2, fontWeight: 600 }}>{label}</div>
      <div style={{ fontSize: 18, fontWeight: 700, color: col }}>{val}</div>
      {unit && <div style={{ fontSize: 10, color: S.textMute }}>{unit}</div>}
    </div>
  );
}

function StatusPill({ status, style: st }) {
  const m = {
    Due: { bg: S.yellowBg, c: S.yellow }, Given: { bg: S.greenBg, c: S.green }, Running: { bg: S.blueBg, c: S.cyan },
    Available: { bg: S.bgInput, c: S.textMute }, Unsigned: { bg: S.yellowBg, c: S.yellow }, Signed: { bg: S.blueBg, c: S.blue },
    Collected: { bg: S.blueBg, c: S.cyan }, Processing: { bg: S.blueBg, c: S.purple }, Completed: { bg: S.greenBg, c: S.green },
    Cancelled: { bg: S.redBg, c: S.red }, Ordered: { bg: S.yellowBg, c: S.yellow }, Draft: { bg: S.yellowBg, c: S.yellow },
  };
  const s = m[status] || { bg: S.bgInput, c: S.textMute };
  return <Pill bg={s.bg} color={s.c} style={st}>{status}</Pill>;
}

function FlagPill({ flag }) {
  const m = {
    CRITICAL: { bg: S.redBg, c: S.red }, HIGH: { bg: S.yellowBg, c: S.yellow }, LOW: { bg: S.yellowBg, c: S.yellow },
    ABNORMAL: { bg: S.yellowBg, c: S.orange }, NORMAL: { bg: S.greenBg, c: S.green }, PENDING: { bg: S.bgInput, c: S.textMute },
  };
  const s = m[flag] || { bg: S.bgInput, c: S.textMute };
  return <Pill bg={s.bg} color={s.c}>{flag}</Pill>;
}

function Badge({ count }) {
  return <span style={{ position: "absolute", top: 4, right: 4, background: S.red, color: "#fff", fontSize: 9, fontWeight: 700, borderRadius: 10, padding: "1px 5px", minWidth: 14, textAlign: "center" }}>{count}</span>;
}

function SectionLabel({ children }) {
  return <div style={{ fontSize: 10, fontWeight: 700, color: S.textMute, textTransform: "uppercase", letterSpacing: 1, marginBottom: 6, marginTop: 4 }}>{children}</div>;
}

function ActivityTile({ icon, label, count, color }) {
  return (
    <div style={{ display: "flex", alignItems: "center", gap: 8, padding: "5px 4px", fontSize: 12, color: S.textSec }}>
      <span>{icon}</span>
      <span style={{ flex: 1 }}>{label}</span>
      <span style={{ fontWeight: 700, color: color || S.textMute, fontSize: 13 }}>{count}</span>
    </div>
  );
}

function SelectSmall({ value, onChange, options }) {
  return (
    <select value={value} onChange={onChange}
      style={{ background: S.bgInput, color: S.textPri, border: `1px solid ${S.border}`, borderRadius: 6, padding: "4px 8px", fontSize: 11, outline: "none" }}>
      {options.map(o => <option key={o}>{o}</option>)}
    </select>
  );
}

function SmallBtn({ children, onClick, color }) {
  return (
    <button onClick={onClick}
      style={{ ...btnStyle, padding: "5px 10px", fontSize: 11, background: S.bgInput, color: color || S.textSec, border: `1px solid ${S.border}`, borderRadius: 6, textAlign: "left" }}>
      {children}
    </button>
  );
}

function Th({ children }) {
  return <th style={{ padding: "6px 10px", fontSize: 11, fontWeight: 600, color: S.textMute, textAlign: "left", borderBottom: `2px solid ${S.border}`, whiteSpace: "nowrap" }}>{children}</th>;
}

function Td({ children, style: st }) {
  return <td style={{ padding: "6px 10px", fontSize: 12, borderBottom: `1px solid ${S.border}`, verticalAlign: "top", ...st }}>{children}</td>;
}

// â”€â”€â”€ BASE STYLES â”€â”€â”€
const btnStyle = { background: "transparent", border: "none", color: S.textPri, cursor: "pointer", fontFamily: "inherit" };
const inputStyle = { background: S.bgInput, color: S.textPri, border: `1px solid ${S.border}`, borderRadius: 6, padding: "6px 10px", fontSize: 12, outline: "none", fontFamily: "inherit" };
const primaryBtnStyle = { ...btnStyle, padding: "6px 18px", background: S.blue, color: "#fff", borderRadius: 6, fontSize: 12, fontWeight: 600 };
const tableStyle = { width: "100%", borderCollapse: "collapse" };
